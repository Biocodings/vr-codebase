#!/bin/bash
#
# This bamcheck wrapper omits three troublesome high-coverage regions
#   on chr2 and chr9 from duplicate reads calculation. It does
#   so by running bamcheck twice and replacing the field 'SN  reads duplicated:' 
#
#	
# After excluding, the mm9/NCBIm37 regions are:
#       1   1   197195432
#       10  1   129993255
#       11  1   121843856
#       12  1   121257530
#       13  1   120284312
#       14  1   125194864
#       15  1   103494974
#       16  1   98319150
#       17  1   95272651
#       18  1   90772031
#       19  1   61342430
#       2   1   98501004
#       2   98508030    181748087
#       3   1   159599783
#       4   1   155630120
#       5   1   152537259
#       6   1   149517037
#       7   1   152524553
#       8   1   131738871
#       9   3039044 35111653
#       9   35113661    124076172
#       MT  1   16299
#       X   1   166650296
#       Y   1   15902555
#
# After excluding, the mm10/GRCm38 regions are:
#	1	1	195471971
#	2	1	98660847
#	2	98667873	182113224
#	3	1	160039680
#	4	1	156508116
#	5	1	151834684
#	6	1	149736546
#	7	1	145441459
#	8	1	129401213
#	9	3039419	35304068
#	9	35306076	124595110
#	10	1	130694993
#	11	1	122082543
#	12	1	120129022
#	13	1	120421639
#	14	1	124902244
#	15	1	104043685
#	16	1	98207768
#	17	1	94987271
#	18	1	90702639
#	19	1	61431566
#	X	1	171031299
#	Y	1	91744698
#	M	1	16299
#


TMPFILE=`mktemp /tmp/bamcheck-mousewrapper.XXXXXXXXXX` || exit 1

die()
{
    if [ -e $TMPFILE ]; then cat $TMPFILE; fi
    rm -f $TMPFILE
    exit 1
}

trap 'die' TERM
trap 'die' INT

read -t 1 -n 1 A && if [ $? -eq 0 ]; then
    echo "The mousewrapper does not accept streamed BAMs."
    exit 1
fi

last=${BASH_ARGV[0]}

if [ "$last" != 37 ] && [ "$last" != 38 ]; then
    echo
    echo "Wrapper usage: $0 [bamcheck options] bamfile [37|38] # where 37 or 38 is the Mouse geneme assembly version"
    echo
    bamcheck
    exit 0
fi

args=${@:1:$(($# - 1))}

if [ "$last" == 37 ]; then
    bamcheck $args -t /lustre/scratch105/vrpipe/refs/mouse/ncbim37/resources/bamcheck-mousewrapper-NCBIm37.regions > $TMPFILE || die
else
    bamcheck $args -t /lustre/scratch105/vrpipe/refs/mouse/GRCm38/resources/bamcheck-mousewrapper-GRCm38.regions > $TMPFILE || die
fi

DUPL=`cat $TMPFILE | grep ^SN | grep 'reads duplicated:'` || die
rm -f $TMPFILE

bamcheck $args | sed "s,^SN\treads duplicated:.*,$DUPL," || die

exit 0

